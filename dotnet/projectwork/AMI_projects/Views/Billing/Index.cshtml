﻿@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "Billing Management";
}

<form id="filterForm" class="row g-3 mb-3 p-3 bg-light border rounded">
    <div class="col-md-3">
        <label for="serialNoFilter" class="form-label">Meter Serial No</label>
        <input id="serialNoFilter" type="text" class="form-control" />
    </div>
    <div class="col-md-3">
        <label for="statusFilter" class="form-label">Status</label>
        <select id="statusFilter" class="form-select">
            <option value="Unpaid" selected>Unpaid</option>
            <option value="Paid">Paid</option>
            <option value="Overdue">Overdue</option>
        </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-search"></i> Search
        </button>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateBillsModal">
            Generate Bills
        </button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
        <thead class="bg-dark text-white">
            <tr>
                <th>Bill ID</th>
                <th>Meter Serial No</th>
                <th>Billing Month</th>
                <th>Total kWh</th>
                <th>Bill Amount</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="billingTableBody">
            <tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>
        </tbody>
    </table>
</div>

<nav id="paginationContainer" aria-label="Page navigation"></nav>

<div class="modal fade" id="generateBillsModal" tabindex="-1" aria-labelledby="generateBillsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateBillsModalLabel">Generate Monthly Bills</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generateBillsForm">
                    <div class="mb-3">
                        <label for="billingMonth" class="form-label">Billing Month</label>
                        <input type="month" class="form-control" id="billingMonth" required>
                        <small>Select the month to generate bills for (e.g., 2025-10).</small>
                    </div>
                    <div id="generateBillError" class="alert alert-danger" style="display: none;"></div>
                    <div id="generateBillSuccess" class="alert alert-success" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="runGenerateButton">Generate</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            var apiToken = "@ViewBag.ApiToken";
            var apiBaseUrl = "@Configuration["ApiBaseUrl"]";
            var currentPage = 1;

            function getErrorMessage(xhr) {
                var errorMsg = "A server error occurred.";
                if (xhr.responseText) {
                    try {
                        var r = JSON.parse(xhr.responseText);
                        errorMsg = r.message || (r.errors ? r.errors.join(' ') : "An error occurred.");
                    } catch (e) { errorMsg = "An unknown error occurred."; }
                }
                return errorMsg;
            }

            function buildPagination(pagination) {
                var container = $('#paginationContainer');
                container.empty();
                if (!pagination || pagination.totalPages <= 1) return;
                var ul = $('<ul class="pagination justify-content-center"></ul>');
                ul.append(`<li class="page-item ${pagination.hasPreviousPage ? '' : 'disabled'}"><a class="page-link" href="#" data-page="${pagination.pageNumber - 1}">Previous</a></li>`);
                for (let i = 1; i <= pagination.totalPages; i++) {
                     ul.append(`<li class="page-item ${i === pagination.pageNumber ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`);
                }
                ul.append(`<li class="page-item ${pagination.hasNextPage ? '' : 'disabled'}"><a class="page-link" href="#" data-page="${pagination.pageNumber + 1}">Next</a></li>`);
                container.append(ul);
            }

            function loadBills(page = 1) {
                currentPage = page;
                var serialNo = $("#serialNoFilter").val();
                var status = $("#statusFilter").val();

                var query = `pageNumber=${page}`;
                if (serialNo) query += `&meterSerialNo=${serialNo}`;
                if (status) query += `&status=${status}`;

                $.ajax({
                    url: `${apiBaseUrl}bills?${query}`,
                    type: "GET",
                    headers: { "Authorization": "Bearer " + apiToken },
                    beforeSend: function() {
                         $('#billingTableBody').html('<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>');
                    },
                    success: function (bills, status, xhr) {
                        var tableBody = $('#billingTableBody');
                        tableBody.empty();
                        if (bills.length === 0) {
                            tableBody.html('<tr><td colspan="8" class="text-center">No bills found.</td></tr>');
                            buildPagination(null);
                            return;
                        }

                        $.each(bills, function (i, bill) {
                            var statusBadge = (bill.status === "Paid")
                                ? `<span class="badge bg-success">${bill.status}</span>`
                                : `<span class="badge bg-warning">${bill.status}</span>`;

                            var actionButton = (bill.status === "Unpaid")
                                ? `<button class="btn btn-success btn-sm pay-btn" data-id="${bill.billId}">Mark as Paid</button>`
                                : '';

                            var row = `<tr>
                                <td>${bill.billId}</td>
                                <td>${bill.meterSerialNo}</td>
                                <td>${new Date(bill.billingMonth).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
                                <td>${bill.totalKwh.toFixed(2)}</td>
                                <td>${bill.totalBillAmount.toFixed(2)}</td>
                                <td>${new Date(bill.dueDate).toLocaleDateString()}</td>
                                <td>${statusBadge}</td>
                                <td>${actionButton}</td>
                            </tr>`;
                            tableBody.append(row);
                        });

                        var paginationHeader = xhr.getResponseHeader('X-Pagination');
                        if (paginationHeader) {
                            buildPagination(JSON.parse(paginationHeader));
                        }
                    },
                    error: function (xhr) {
                         $('#billingTableBody').html(`<tr><td colspan="8" class="text-center text-danger">Error: ${getErrorMessage(xhr)}</td></tr>`);
                         buildPagination(null);
                    }
                });
            }

            // --- EVENT HANDLERS ---
            $('#filterForm').on('submit', function(e) { e.preventDefault(); loadBills(1); });
            $(document).on('click', '.page-link', function(e) { e.preventDefault(); var page = $(this).data('page'); if (page) loadBills(page); });
            $('#generateBillsModal').on('hidden.bs.modal', function () {
                $('#generateBillsForm')[0].reset();
                $('#generateBillError, #generateBillSuccess').hide();
                $('#runGenerateButton').prop('disabled', false).text('Generate');
            });

            // Mark as Paid
            $(document).on('click', '.pay-btn', function () {
                var billId = $(this).data('id');
                var button = $(this);

                if (confirm('Are you sure you want to mark bill ' + billId + ' as Paid?')) {
                    $.ajax({
                        url: "@Url.Action("MarkAsPaid", "Billing")/" + billId,
                        type: "POST", // This calls our C# controller
                        success: function () {
                            loadBills(currentPage); // Reload the table
                        },
                        error: function (xhr) { alert("Error: " + getErrorMessage(xhr)); }
                    });
                }
            });

            // Generate Bills
            $('#runGenerateButton').on('click', function () {
                var month = $('#billingMonth').val();
                if (!month) {
                    $('#generateBillError').text('Please select a month.').show();
                    return;
                }

                $(this).prop('disabled', true).text('Generating...');
                $('#generateBillError, #generateBillSuccess').hide();

                $.ajax({
                    url: "@Url.Action("GenerateBills", "Billing")", // Calls our C# controller
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ billingMonth: month }),
                    success: function (response) {
                        $('#runGenerateButton').prop('disabled', false).text('Generate');
                        $('#generateBillSuccess').html(
                            `<strong>Success!</strong><br>
                             Generated: ${response.successfullyGenerated}<br>
                             Already Exist: ${response.alreadyExist}<br>
                             No Readings: ${response.noReadingsFound}`
                        ).show();
                        loadBills(1); // Reload the main table
                    },
                    error: function (xhr) {
                        $('#runGenerateButton').prop('disabled', false).text('Generate');
                        $('#generateBillError').text(getErrorMessage(xhr)).show();
                    }
                });
            });

            // --- Initial Load ---
            loadBills(1);
        });
    </script>
}