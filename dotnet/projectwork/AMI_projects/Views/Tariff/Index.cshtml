@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "Tariff Data";
}

<div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTariffModal">
        <i class="bi bi-plus-lg"></i> Add Tariff
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
        <thead class="bg-dark text-white">
            <tr>
                <th>Tariff ID</th>
                <th>Name</th>
                <th>Effective From</th>
                <th>Effective To</th>
                <th>Base Rate</th>
                <th>Tax Rate</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tariffTableBody">
            <tr>
                <td colspan="7" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="addTariffModal" tabindex="-1" aria-labelledby="addTariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTariffModalLabel">Add New Tariff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTariffForm">
                    <div class="mb-3">
                        <label for="tariffName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="tariffName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="effectiveFrom" class="form-label">Effective From</label>
                            <input type="date" class="form-control" id="effectiveFrom" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="effectiveTo" class="form-label">Effective To (Optional)</label>
                            <input type="date" class="form-control" id="effectiveTo">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="baseRate" class="form-label">Base Rate</label>
                            <input type="number" step="0.01" class="form-control" id="baseRate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taxRate" class="form-label">Tax Rate (e.g., 0.18 for 18%)</label>
                            <input type="number" step="0.01" class="form-control" id="taxRate" value="0">
                        </div>
                    </div>
                    <div id="addTariffError" class="alert alert-danger" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveTariffButton">Save changes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            var apiToken = "@ViewBag.ApiToken";
            var apiBaseUrl = "@Configuration["ApiBaseUrl"]";

            // --- Helper: Get API error message ---
            function getErrorMessage(xhr) {
                var errorMsg = "A server error occurred.";
                if (xhr.responseText) {
                    try {
                        var response = JSON.parse(xhr.responseText);
                        errorMsg = response.message || xhr.responseText;
                    } catch (e) { errorMsg = xhr.responseText; }
                }
                return errorMsg;
            }

            // --- MAIN FUNCTION: Load Tariffs ---
            function loadTariffs() {
                $.ajax({
                    url: `${apiBaseUrl}tariffs`,
                    type: "GET",
                    headers: { "Authorization": "Bearer " + apiToken },
                    beforeSend: function() {
                         $('#tariffTableBody').html('<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>');
                    },
                    success: function (tariffs) {
                        var tableBody = $('#tariffTableBody');
                        tableBody.empty();

                        if (tariffs.length === 0) {
                            tableBody.html('<tr><td colspan="7" class="text-center">No tariffs found.</td></tr>');
                            return;
                        }

                        $.each(tariffs, function (i, tariff) {
                            var effectiveTo = tariff.effectiveTo ? new Date(tariff.effectiveTo).toLocaleDateString() : '—';
                            var baseRate = parseFloat(tariff.baseRate).toFixed(2);
                            var taxRate = (parseFloat(tariff.taxRate) * 100).toFixed(2) + '%';

                            var row = `<tr>
                                <td>${tariff.tariffId}</td>
                                <td>${tariff.name}</td>
                                <td>${new Date(tariff.effectiveFrom).toLocaleDateString()}</td>
                                <td>${effectiveTo}</td>
                                <td>${baseRate}</td>
                                <td>${taxRate}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="${tariff.tariffId}">Delete</button>
                                </td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    },
                    error: function (xhr) {
                         $('#tariffTableBody').html(`<tr><td colspan="7" class="text-center text-danger">Error: ${getErrorMessage(xhr)}</td></tr>`);
                    }
                });
            }

            // --- 1. ADD: Click handler for "Save changes" button ---
            $("#saveTariffButton").on("click", function () {
                var tariffData = {
                    name: $("#tariffName").val(),
                    effectiveFrom: $("#effectiveFrom").val(),
                    effectiveTo: $("#effectiveTo").val() || null,
                    baseRate: parseFloat($("#baseRate").val()),
                    taxRate: parseFloat($("#taxRate").val())
                };

                if (!tariffData.name || !tariffData.effectiveFrom || isNaN(tariffData.baseRate)) {
                    $("#addTariffError").text("Name, Effective From, and Base Rate are required.").show();
                    return;
                } else {
                    $("#addTariffError").hide();
                }

                $.ajax({
                    url: "@Url.Action("Create", "Tariff")", // Calls our C# controller
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(tariffData),
                    success: function (response) {
                        $('#addTariffModal').modal('hide');
                        loadTariffs(); // Reload the table
                    },
                    error: function (xhr) {
                        $("#addTariffError").text(getErrorMessage(xhr)).show();
                    }
                });
            });

            // --- 2. DELETE: Click handler for table "Delete" buttons ---
            $(document).on('click', '.delete-btn', function () {
                var tariffId = $(this).data('id');

                if (confirm('Are you sure you want to delete this tariff?')) {
                    $.ajax({
                        url: "@Url.Action("Delete", "Tariff")/" + tariffId, // Calls our C# controller
                        type: "DELETE",
                        success: function (response) {
                            loadTariffs(); // Reload the table
                        },
                        error: function (xhr) {
                            var errorMsg = getErrorMessage(xhr);
                            if (errorMsg.includes("Conflict")) {
                                alert("Error: Cannot delete tariff. It is likely in use or has slabs.");
                            } else {
                                alert("Error: " + errorMsg);
                            }
                        }
                    });
                }
            });

            // --- 3. Modal Reset ---
            $('#addTariffModal').on('hidden.bs.modal', function () {
                $('#addTariffForm')[0].reset();
                $("#addTariffError").hide().text("");
            });

            // --- Initial Load ---
            loadTariffs();
        });
    </script>
}