@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "Tariff Slab Data";
    // We no longer need the @tariffs variable from the ViewBag
}

<div class="row mb-3 p-3 bg-light border rounded">
    <div class="col-md-4">
        <label for="tariff-select" class="form-label">Select Tariff:</label>
        <select id="tariff-select" class="form-select">
            <option value="0" selected>-- Loading Tariffs... --</option>
        </select>
    </div>
    <div class="col-md-8 d-flex align-items-end">
        <button id="add-slab-btn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSlabModal" disabled>
            <i class="bi bi-plus-lg"></i> Add Slab
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
        <thead class="bg-dark text-white">
            <tr>
                <th>Slab ID</th>
                <th>From (kWh)</th>
                <th>To (kWh)</th>
                <th>Rate per kWh</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="slab-table-body">
            <tr>
                <td colspan="5" class="text-center text-muted">Please select a tariff to load slabs...</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="addSlabModal" tabindex="-1" aria-labelledby="addSlabModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSlabModalLabel">Add New Slab</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSlabForm">
                    <input type="hidden" id="slabTariffId">

                    <div class="mb-3">
                        <label for="slabFromKwh" class="form-label">From (kWh)</label>
                        <input type="number" step="0.01" class="form-control" id="slabFromKwh" required>
                    </div>
                    <div class="mb-3">
                        <label for="slabToKwh" class="form-label">To (kWh)</label>
                        <input type="number" step="0.01" class="form-control" id="slabToKwh" required>
                    </div>
                    <div class="mb-3">
                        <label for="slabRate" class="form-label">Rate per kWh</label>
                        <input type="number" step="0.0001" class="form-control" id="slabRate" required>
                    </div>
                    <div id="addSlabError" class="alert alert-danger" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveSlabButton">Save changes</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {

            var apiToken = "@ViewBag.ApiToken";
            var apiBaseUrl = "@Configuration["ApiBaseUrl"]";

            // --- Helper: Get API error message ---
            function getErrorMessage(xhr) {
                var errorMsg = "A server error occurred.";
                if (xhr.responseText) {
                    try {
                        var response = JSON.parse(xhr.responseText);
                        errorMsg = response.message || xhr.responseText;
                    } catch (e) { errorMsg = xhr.responseText; }
                }
                return errorMsg;
            }

            // --- Helper function to build the table ---
            function populateSlabTable(slabs) {
                var tableBody = $('#slab-table-body');
                tableBody.empty();

                if (slabs.length === 0) {
                    tableBody.append('<tr><td colspan="5" class="text-center text-muted">No slabs found for this tariff.</td></tr>');
                    return;
                }

                $.each(slabs, function (i, slab) {
                    var row = `<tr>
                        <td>${slab.tariffSlabId}</td>
                        <td>${slab.fromKwh.toFixed(2)}</td>
                        <td>${slab.toKwh.toFixed(2)}</td>
                        <td>${slab.ratePerKwh.toFixed(4)}</td>
                        <td><button class="btn btn-danger btn-sm delete-btn" data-id="${slab.tariffSlabId}">Delete</button></td>
                    </tr>`;
                    tableBody.append(row);
                });
            }

            // --- Function to refresh the slab table ---
            function refreshSlabs() {
                var tariffId = $('#tariff-select').val();
                if (tariffId > 0) {
                    // This calls our C# controller, which is fine
                    $.get('@Url.Action("GetSlabsForTariff", "TariffSlabs")?tariffId=' + tariffId, function (data) {
                        populateSlabTable(data);
                    });
                }
            }

            // --- NEW: Load Tariffs on page load ---
            function loadTariffDropdown() {
                $.ajax({
                    url: `${apiBaseUrl}tariffs`,
                    type: "GET",
                    headers: { "Authorization": "Bearer " + apiToken },
                    success: function (tariffs) {
                        var dropdown = $('#tariff-select');
                        dropdown.empty();
                        dropdown.append($('<option>', { value: 0, text: '-- Select a Tariff --' }));

                        $.each(tariffs, function (i, tariff) {
                            dropdown.append($('<option>', {
                                value: tariff.tariffId,
                                text: tariff.name
                            }));
                        });
                    },
                    error: function (xhr) {
                        $('#tariff-select').empty()
                            .append($('<option>', { value: 0, text: 'Error loading tariffs.' }));
                    }
                });
            }

            // --- When the Tariff dropdown changes ---
            $('#tariff-select').change(function () {
                var tariffId = $(this).val();

                if (tariffId > 0) {
                    $('#add-slab-btn').prop('disabled', false);
                    $('#slabTariffId').val(tariffId);
                    refreshSlabs();
                } else {
                    $('#add-slab-btn').prop('disabled', true);
                    $('#slabTariffId').val('');
                    $('#slab-table-body').empty().append('<tr><td colspan="5" class="text-center text-muted">Please select a tariff to load slabs...</td></tr>');
                }
            });

            // --- 1. ADD: Click handler for "Save changes" button ---
            $('#saveSlabButton').on('click', function () {
                var slabData = {
                    tariffId: parseInt($('#slabTariffId').val()),
                    fromKwh: parseFloat($('#slabFromKwh').val()),
                    toKwh: parseFloat($('#slabToKwh').val()),
                    ratePerKwh: parseFloat($('#slabRate').val())
                };

                if (!slabData.tariffId || isNaN(slabData.fromKwh) || isNaN(slabData.toKwh) || isNaN(slabData.ratePerKwh)) {
                    $("#addSlabError").text("All fields are required and must be numbers.").show();
                    return;
                } else {
                    $("#addSlabError").hide();
                }

                $.ajax({
                    url: "@Url.Action("Create", "TariffSlabs")",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(slabData),
                    success: function (response) {
                        $('#addSlabModal').modal('hide');
                        refreshSlabs(); // Reload the table
                    },
                    error: function (xhr) {
                        $("#addSlabError").text(getErrorMessage(xhr)).show();
                    }
                });
            });

            // --- 2. DELETE: Click handler for table "Delete" buttons ---
            $(document).on('click', '.delete-btn', function () {
                var slabId = $(this).data('id');

                if (confirm('Are you sure you want to delete this slab?')) {
                    $.ajax({
                        url: "@Url.Action("Delete", "TariffSlabs")/" + slabId,
                        type: "DELETE",
                        success: function (response) {
                            refreshSlabs(); // Reload the table
                        },
                        error: function (xhr) {
                            alert("Error: " + getErrorMessage(xhr));
                        }
                    });
                }
            });

            // --- 3. Modal Reset ---
            $('#addSlabModal').on('hidden.bs.modal', function () {
                $('#addSlabForm')[0].reset();
                $("#addSlabError").hide().text("");
            });

            // --- Initial Load ---
            loadTariffDropdown();
        });
    </script>
}